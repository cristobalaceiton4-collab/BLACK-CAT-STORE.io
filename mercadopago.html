<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - Black Cat Store</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .seccion {
            padding: 20px;
        }

        .seccion h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 22px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* RESUMEN DE COMPRA */
        .resumen-compra {
            background: #f8f9fa;
            border-radius: 15px;
            height: fit-content;
        }

        .item-resumen {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
        }

        .item-resumen:last-child {
            border-bottom: none;
        }

        .item-info h4 {
            color: #333;
            font-size: 15px;
            margin-bottom: 5px;
        }

        .item-info p {
            color: #666;
            font-size: 13px;
        }

        .item-precio {
            color: #667eea;
            font-weight: bold;
            font-size: 16px;
        }

        .total-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 3px solid #667eea;
        }

        .total-section h3 {
            display: flex;
            justify-content: space-between;
            color: #333;
            font-size: 22px;
        }

        /* FORMULARIO DE ENV√çO */
        .formulario-envio {
            border-right: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* FORMULARIO DE PAGO */
        .logo-mp {
            text-align: center;
            margin-bottom: 15px;
        }

        .btn-pagar {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-pagar:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-pagar:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-volver {
            width: 100%;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-volver:hover {
            background: #5a6268;
        }

        .mensaje-error {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            font-size: 13px;
        }

        .mensaje-exito {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            font-size: 13px;
        }

        .secure-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #666;
            font-size: 12px;
            margin-top: 15px;
        }

        .secure-badge svg {
            width: 18px;
            height: 18px;
            fill: #4caf50;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading .spinner {
            display: block;
        }

        .loading .btn-text {
            display: none;
        }

        .carrito-vacio {
            text-align: center;
            padding: 40px;
            grid-column: 1 / -1;
        }

        .carrito-vacio h2 {
            color: #666;
            margin-bottom: 20px;
        }

        .required {
            color: #ff4444;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .formulario-envio {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
                padding-bottom: 30px;
            }
        }

        @media (max-width: 768px) {
            .row {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="container" id="container-principal">
        
        <!-- FORMULARIO DE ENV√çO -->
        <div class="seccion formulario-envio">
            <h2>üì¶ Datos de Env√≠o</h2>

            <form id="form-envio">
                
                <div class="form-group">
                    <label for="nombre">Nombre Completo <span class="required">*</span></label>
                    <input 
                        type="text" 
                        id="nombre" 
                        name="nombre"
                        placeholder="Juan P√©rez"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="rut">RUT <span class="required">*</span></label>
                    <input 
                        type="text" 
                        id="rut" 
                        name="rut"
                        placeholder="12.345.678-9"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="email">Email <span class="required">*</span></label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email"
                        placeholder="tu@email.com"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="telefono">Tel√©fono <span class="required">*</span></label>
                    <input 
                        type="tel" 
                        id="telefono" 
                        name="telefono"
                        placeholder="+56 9 1234 5678"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="direccion">Direcci√≥n Completa <span class="required">*</span></label>
                    <input 
                        type="text" 
                        id="direccion" 
                        name="direccion"
                        placeholder="Av. Principal 123, Depto 456"
                        required
                    >
                </div>

                <div class="row">
                    <div class="form-group">
                        <label for="ciudad">Ciudad <span class="required">*</span></label>
                        <input 
                            type="text" 
                            id="ciudad" 
                            name="ciudad"
                            placeholder="Santiago"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="comuna">Comuna <span class="required">*</span></label>
                        <input 
                            type="text" 
                            id="comuna" 
                            name="comuna"
                            placeholder="Las Condes"
                            required
                        >
                    </div>
                </div>

                <div class="form-group">
                    <label for="region">Regi√≥n <span class="required">*</span></label>
                    <select id="region" name="region" required>
                        <option value="">Seleccionar regi√≥n</option>
                        <option value="Arica y Parinacota">Arica y Parinacota</option>
                        <option value="Tarapac√°">Tarapac√°</option>
                        <option value="Antofagasta">Antofagasta</option>
                        <option value="Atacama">Atacama</option>
                        <option value="Coquimbo">Coquimbo</option>
                        <option value="Valpara√≠so">Valpara√≠so</option>
                        <option value="Metropolitana">Metropolitana</option>
                        <option value="O'Higgins">O'Higgins</option>
                        <option value="Maule">Maule</option>
                        <option value="√ëuble">√ëuble</option>
                        <option value="Biob√≠o">Biob√≠o</option>
                        <option value="Araucan√≠a">Araucan√≠a</option>
                        <option value="Los R√≠os">Los R√≠os</option>
                        <option value="Los Lagos">Los Lagos</option>
                        <option value="Ays√©n">Ays√©n</option>
                        <option value="Magallanes">Magallanes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="codigo_postal">C√≥digo Postal</label>
                    <input 
                        type="text" 
                        id="codigo_postal" 
                        name="codigo_postal"
                        placeholder="8320000"
                    >
                </div>

                <div class="form-group">
                    <label for="notas">Notas adicionales (Opcional)</label>
                    <input 
                        type="text" 
                        id="notas" 
                        name="notas"
                        placeholder="Ej: Dejar con el conserje"
                    >
                </div>

            </form>
        </div>

        <!-- RESUMEN DE COMPRA -->
        <div class="seccion resumen-compra">
            <h2>üõçÔ∏è Resumen de Compra</h2>
            
            <div id="items-container">
                <!-- Los items se cargar√°n din√°micamente aqu√≠ -->
            </div>

            <div class="total-section">
                <h3>
                    <span>Total:</span>
                    <span id="total-amount">$0</span>
                </h3>
            </div>

            <button class="btn-volver" onclick="window.location.href='carrito.html'">
                ‚Üê Volver al Carrito
            </button>
        </div>

        <!-- FORMULARIO DE PAGO -->
        <div class="seccion formulario-pago">
            
            <div class="logo-mp">
                <svg width="180" height="50" viewBox="0 0 200 60" fill="none">
                    <rect width="200" height="60" rx="10" fill="#009EE3"/>
                    <text x="100" y="38" font-family="Arial, sans-serif" font-size="22" font-weight="bold" fill="white" text-anchor="middle">Mercado Pago</text>
                </svg>
            </div>

            <h2>üí≥ Datos de Pago</h2>

            <div class="mensaje-error" id="mensaje-error"></div>
            <div class="mensaje-exito" id="mensaje-exito"></div>

            <form id="form-pago">
                
                <div class="form-group">
                    <label for="cardNumber">N√∫mero de Tarjeta <span class="required">*</span></label>
                    <input 
                        type="text" 
                        id="cardNumber" 
                        name="cardNumber"
                        placeholder="1234 5678 9012 3456"
                        maxlength="19"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="cardholderName">Titular <span class="required">*</span></label>
                    <input 
                        type="text" 
                        id="cardholderName" 
                        name="cardholderName"
                        placeholder="Como aparece en la tarjeta"
                        required
                    >
                </div>

                <div class="row">
                    <div class="form-group">
                        <label for="expirationDate">Vencimiento <span class="required">*</span></label>
                        <input 
                            type="text" 
                            id="expirationDate" 
                            name="expirationDate"
                            placeholder="MM/AA"
                            maxlength="5"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="securityCode">CVV <span class="required">*</span></label>
                        <input 
                            type="text" 
                            id="securityCode" 
                            name="securityCode"
                            placeholder="123"
                            maxlength="4"
                            required
                        >
                    </div>
                </div>

                <button type="submit" class="btn-pagar" id="btn-pagar">
                    <span class="btn-text" id="btn-text">Pagar $0</span>
                    <div class="spinner"></div>
                </button>

                <div class="secure-badge">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                    </svg>
                    Pago 100% Seguro
                </div>

            </form>

        </div>

    </div>

    <script>
        // ========================================
        // CARGAR PRODUCTOS DEL CARRITO
        // ========================================
        
        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        let totalAmount = 0;

        function cargarResumen() {
            const itemsContainer = document.getElementById('items-container');
            const totalElement = document.getElementById('total-amount');
            const btnText = document.getElementById('btn-text');
            const container = document.getElementById('container-principal');

            if (carrito.length === 0) {
                container.innerHTML = `
                    <div class="carrito-vacio">
                        <h2>No hay productos en el carrito</h2>
                        <button class="btn-volver" onclick="window.location.href='index.html'">
                            ‚Üê Volver a la Tienda
                        </button>
                    </div>
                `;
                return;
            }

            itemsContainer.innerHTML = '';
            totalAmount = 0;

            carrito.forEach(item => {
                const subtotal = item.precio * item.cantidad;
                totalAmount += subtotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-resumen';
                itemDiv.innerHTML = `
                    <div class="item-info">
                        <h4>${item.nombre}</h4>
                        <p>Cantidad: ${item.cantidad} √ó $${item.precio.toLocaleString('es-CL')}</p>
                    </div>
                    <div class="item-precio">$${subtotal.toLocaleString('es-CL')}</div>
                `;
                itemsContainer.appendChild(itemDiv);
            });

            totalElement.textContent = `$${totalAmount.toLocaleString('es-CL')}`;
            btnText.textContent = `Pagar $${totalAmount.toLocaleString('es-CL')}`;
        }

        cargarResumen();

        // ========================================
        // FORMATEO DE INPUTS
        // ========================================
        
        // Formatear RUT
        document.getElementById('rut').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\dkK]/g, '');
            if (value.length > 1) {
                value = value.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.') + '-' + value.slice(-1);
            }
            e.target.value = value;
        });

        // Formatear tel√©fono
        document.getElementById('telefono').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('56')) {
                value = '+56 ' + value.substring(2);
            } else if (value.startsWith('9')) {
                value = '+56 9 ' + value.substring(1);
            }
            e.target.value = value;
        });

        // Formatear n√∫mero de tarjeta
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
        });

        // Formatear fecha de expiraci√≥n
        document.getElementById('expirationDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });

        // Solo n√∫meros en CVV
        document.getElementById('securityCode').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // ========================================
        // VALIDACI√ìN DE FORMULARIO DE ENV√çO
        // ========================================
        
        function validarFormularioEnvio() {
            const form = document.getElementById('form-envio');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return false;
            }
            
            const rut = document.getElementById('rut').value;
            if (rut.length < 9) {
                mostrarError('Por favor ingresa un RUT v√°lido');
                return false;
            }
            
            return true;
        }

        // ========================================
        // PROCESAMIENTO DEL PAGO
        // ========================================
        
        document.getElementById('form-pago').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Primero validar datos de env√≠o
            if (!validarFormularioEnvio()) {
                mostrarError('Por favor completa todos los datos de env√≠o requeridos');
                return;
            }
            
            const btnPagar = document.getElementById('btn-pagar');
            const mensajeError = document.getElementById('mensaje-error');
            const mensajeExito = document.getElementById('mensaje-exito');
            
            mensajeError.style.display = 'none';
            mensajeExito.style.display = 'none';
            
            btnPagar.classList.add('loading');
            btnPagar.disabled = true;

            // Validar datos de pago
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const securityCode = document.getElementById('securityCode').value;

            if (cardNumber.length < 15 || cardNumber.length > 16) {
                mostrarError('N√∫mero de tarjeta inv√°lido');
                return;
            }

            if (securityCode.length < 3 || securityCode.length > 4) {
                mostrarError('CVV inv√°lido');
                return;
            }

            try {
                // Recopilar todos los datos
                const datosEnvio = {
                    nombre: document.getElementById('nombre').value,
                    rut: document.getElementById('rut').value,
                    email: document.getElementById('email').value,
                    telefono: document.getElementById('telefono').value,
                    direccion: document.getElementById('direccion').value,
                    ciudad: document.getElementById('ciudad').value,
                    comuna: document.getElementById('comuna').value,
                    region: document.getElementById('region').value,
                    codigo_postal: document.getElementById('codigo_postal').value,
                    notas: document.getElementById('notas').value
                };

                // Preparar productos
                let productosTexto = '';
                carrito.forEach((item, index) => {
                    productosTexto += `\n${index + 1}. ${item.nombre} - Cantidad: ${item.cantidad} - Precio: $${item.precio.toLocaleString('es-CL')} - Subtotal: $${(item.precio * item.cantidad).toLocaleString('es-CL')}`;
                });

                // Enviar a Formcarry
                const response = await fetch('https://formcarry.com/s/G2-4JWg2zGN', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        nombre: datosEnvio.nombre,
                        rut: datosEnvio.rut,
                        email: datosEnvio.email,
                        telefono: datosEnvio.telefono,
                        direccion: datosEnvio.direccion,
                        ciudad: datosEnvio.ciudad,
                        comuna: datosEnvio.comuna,
                        region: datosEnvio.region,
                        codigo_postal: datosEnvio.codigo_postal,
                        notas: datosEnvio.notas,
                        productos: productosTexto,
                        total: `$${totalAmount.toLocaleString('es-CL')}`,
                        fecha_pedido: new Date().toLocaleString('es-CL')
                    })
                });

                if (response.ok) {
                    mostrarExito('¬°Pedido procesado exitosamente! Redirigiendo...');
                    
                    setTimeout(() => {
                        localStorage.removeItem('carrito');
                        alert('¬°Compra realizada con √©xito! Recibir√°s un email con la confirmaci√≥n.');
                        window.location.href = 'index.html';
                    }, 2000);
                } else {
                    throw new Error('Error al procesar el pedido');
                }

            } catch (error) {
                console.error('Error:', error);
                mostrarError('Error al procesar el pedido. Por favor intenta nuevamente.');
            }
        });

        function mostrarError(mensaje) {
            const mensajeError = document.getElementById('mensaje-error');
            const btnPagar = document.getElementById('btn-pagar');
            
            mensajeError.textContent = mensaje;
            mensajeError.style.display = 'block';
            
            btnPagar.classList.remove('loading');
            btnPagar.disabled = false;
            
            // Scroll al error
            mensajeError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function mostrarExito(mensaje) {
            const mensajeExito = document.getElementById('mensaje-exito');
            
            mensajeExito.textContent = mensaje;
            mensajeExito.style.display = 'block';
        }
    </script>

</body>
</html>